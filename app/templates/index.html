{% extends "base.html" %}
{% block content %}

<nav class="navbar navbar-inverse navbar-fixed-top">
  <div class="container-fluid">
    <div class="navbar-header">
      <div class="navbar-header">
        <a class="navbar-brand" href="#">Project Timeline</a>
      </div>
      <ul class="nav navbar-nav">
        <li><a data-toggle="tab" href="#dashboard">Dashboard</a></li>
        <li><a data-toggle="tab" href="#management">Management</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="tab-content">
	<div id="dashboard" class="tab-pane fade in active">
        <h1 style="text-align:center">Dashboard of Projects Timeline</h1>

		<p>
		 	<b>Descriptions:</b> The timeline of our projects.
		</p>
		<div id="visualization"></div>
    </div>

    <div id="management" class="tab-pane fade container">
        <h1 style="text-align:center">Projects Management</h1>
		<table id="projectTable" class="display" cellspacing="0" width="100%">
		    <thead>
		        <tr>
		            <th>Name</th>
		            <th>Start Date</th>
		            <th>End Date</th>
		            <th>Milestone</th>
		            <th>Priority</th>
		        </tr>
		    </thead>
		    <tfoot>
		        <tr>
		            <th>Name</th>
		            <th>Start Date</th>
		            <th>End Date</th>
		            <th>Milestone</th>
		            <th>Priority</th>
		        </tr>
		    </tfoot>
		</table>
    </div>

</div><!-- /.container -->


<script type="text/javascript">


	renderTimeline();
	
/*
  // DOM element where the Timeline will be attached
  var container = document.getElementById('visualization');

  // Create a DataSet (allows two way data-binding)
  var items = new vis.DataSet(
    {% autoescape false %}
    {{initalData}}
    {% endautoescape %}
  );

  // Configuration for the Timeline
  var options = {
  	editable: true
  };

  // Create a Timeline
  var timeline = new vis.Timeline(container, items, options);
*/

	var editor; // use a global for the submit and return data rendering in the examples
 
	$(document).ready(function() {
	    editor = new $.fn.dataTable.Editor( {
	        ajax: {
	        	create: {
	        		type: 'POST',
	        		url: '/post'
	        	},
	        	edit: {
	        		type: 'PUT',
	        		url: '/put'
	        	},
	        	remove: {
	        		type: 'DELETE',
	        		url: '/delete'
	        	}
	        },
	        table: "#projectTable",
	        fields: [ {
	                label: "Name:",
	                name: "name_P"
	            }, {
	                label: "Start date:",
	                name: "start_date",
	                type: "datetime"
	            }, {
	                label: "End date:",
	                name: "end_date",
	                type: "datetime"
	            }, {
	                label: "Milestone:",
	                name: "milestone"
	            }, {
	                label: "Priority:",
	                name: "priority_p"
	            }
	        ]
	    });
	 
	    editor.on( 'postSubmit', function(e, json, data, action) {
	    	renderTimeline();
	    });

	    $('#projectTable').DataTable( {		//create a table
	        dom: "Bfrtip",					//add buttons to the table
	        ajax: {							//load the table
	        	type: 'GET',
	        	url: '/get',
	        	dataType: 'json'
	        },
	        columns: [
	            { data: "name_P" },
	            { data: "start_date" },
	            { data: "end_date" },
	            { data: "milestone" },
	            { data: "priority_p" }
	        ],
	        select: true,
	        buttons: [
	            { extend: "create", editor: editor },
	            { extend: "edit",   editor: editor },
	            { extend: "remove", editor: editor }
	        ]
	    });
	});

	var Colors = ['red', 'gold', 'greenyellow', 'skyblue', 'magenta', 'chocolate', 'mediumSeaGreen', 'royalblue', 'blueviolet', 'lightcoral'];

	function renderTimeline() {
		$.ajax({
			url: '/get',
			success: function (data) {
			  // hide the "loading..." message
			  //document.getElementById('loading').style.display = 'none';

			  // DOM element where the Timeline will be attached
			  var container = document.getElementById('visualization');

			  var currentTime = new Date();
			  var ColorsFlag = [];
			  for (var i  = 0; i < Colors.length; i++) {
			  	ColorsFlag.push(null);
			  }

			  var transData = [];
			  data["data"].forEach(function(e) {
			  	var obj = {};
			  	obj["start"] = e["end_date"];

			  	obj["content"] = e["end_date"].substring(5, 10) + '<br>' + e["name_P"] + '<br>' + e["milestone"];
			  	obj["className"] = getColor(e["name_P"], ColorsFlag) + "-size" + getSize(e["end_date"]);

			  	transData.push(obj);
			  });

			  

			  // Create a DataSet (allows two way data-binding)
			  var items = new vis.DataSet(transData);

			  // Configuration for the Timeline
			  var options = {
			  	editable: true,
			  	start: currentTime.setDate(currentTime.getDate() - 4),
			  	end: currentTime.setDate(currentTime.getDate() + 18),
			  	zoomMin: 1000 * 60 * 60 * 24 * 15,
    			zoomMax: 1000 * 60 * 60 * 24 * 31 * 6,
    			minHeight: 300,
    			maxHeight: 900
			  };

			  //remove the page
			  container.innerHTML="";
			  // Create a Timeline
			  var timeline = new vis.Timeline(container);
			  timeline.setOptions(options);
			  timeline.setItems(items);
			},
			error: function (err) {
			  console.log('Error', err);
			  if (err.status === 0) {
			    alert('Failed to load data.\nPlease run this example on a server.');
			  }
			  else {
			    alert('Failed to load data.');
			  }
			}
		});
	}


	function getColor(name, colorsFlag) {
		var color;

		var code = (name.hashCode()%Colors.length+Colors.length)%Colors.length;
		if (colorsFlag[code] == null) {
			color = Colors[code];
			colorsFlag[code] = name;
		}
		else if (name === colorsFlag[code]){
			color = Colors[code];
		}
		else {
			var index = code+1;
			while (index != code) {
				if (colorsFlag[index] == null) {
					color = Colors[index];
					colorsFlag[index] = name;
					break;
				}
				else if (name === colorsFlag[index]) {
					color = Colors[index];
					break;
				}
				else {
					index = (index+1)%Colors.length;
				}
			}
		}
		return color;
	}

	function getSize(endDate) {
		var size;
		var currentDate = (new Date()).toISOString().substring(0,10);
		var endDateTime = new Date(endDate).getTime();
		var currentTime = new Date(currentDate).getTime();
	  	if (endDateTime < (new Date()).getTime()) { //endDate before this moment
	  		size = 'default';
	  	}
	  	else if (endDateTime - currentTime < 3*24*60*60*1000) { //within 3 days
	  		size = "3";
	  	}
	  	else if (endDateTime - currentTime < 7*24*60*60*1000) { //3~7 days
	  		size = "2";
	  	}
	  	else if (endDateTime - currentTime < 15*24*60*60*1000) { //7~15 days
	  		size = "1";
	  	}
	  	else { //after 15 days
	  		size = "0";
	  	}
	  	
	  	return size;
	}


	String.prototype.hashCode = function(){
		var hash = 0;
		if (this.length == 0) return hash;
		for (i = 0; i < this.length; i++) {
			char = this.charCodeAt(i);
			hash = ((hash<<5)-hash)+char;
			hash = hash & hash; // Convert to 32bit integer
		}
		return hash;
	}


</script>


<script src="static/js/bootstrap.min.js"></script>
<!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
<script src="static/js/ie10-viewport-bug-workaround.js"></script>

{% endblock %}